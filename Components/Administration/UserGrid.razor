@using Finance_Monitor.Components.Shared
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using Finance_Monitor.Models
@using Finance_Monitor.Data
@using Microsoft.AspNetCore.Identity;

@implements IAsyncDisposable

@inject IDbContextFactory<ApplicationUserContext> DbFactory
@inject UserManager<ApplicationUser> UserManager

<div class="user-grid">
    <QuickGrid Class="table" Items="@FilteredUsers" Virtualize="true">
        <PropertyColumn Property="User => User.UserName" Sortable="true" InitialSortDirection="SortDirection.Ascending" IsDefaultSortColumn="true" >
            <ColumnOptions>
                <div class="search-box">
                    <input type="search" @bind="UserNameFilter" @bind:event="oninput" placeholder="username" />
                </div>
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="User => User.Email">
            <ColumnOptions>
                <div class="search-box">
                    <input type="search" @bind="EmailFilter" @bind:event="oninput" placeholder="email" />
                </div>
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="User => User.Name" Sortable="true">
            <ColumnOptions>
                <div class="search-box">
                    <input type="search" autofocus @bind="NameFilter" @bind:event="oninput" placeholder="name" />
                </div>
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="User => User.FirstName">
            <ColumnOptions>
                <div class="search-box">
                    <input type="search" @bind="FirstNameFilter" @bind:event="oninput" placeholder="first name" />
                </div>
            </ColumnOptions>
        </PropertyColumn>

        <TemplateColumn Context="User">
            <button class="btn btn-primary" @onclick="() => EditUser(User.Id)">Edit</button>
            <button class="btn btn-danger" @onclick="() => DeleteUser(User)">Delete</button>
        </TemplateColumn>
    </QuickGrid>
</div>

<DialogComponent @ref="ConfirmationDialog"
                DialogUser=@dialogUser
                DialogTitle="Delete User"
                DialogMessage=@confirmationMessage
                DialogAction="DeleteUserConfirmed">
</DialogComponent>

@code {
    private ApplicationUserContext context = default!;

    private string UserNameFilter = string.Empty;
    private string EmailFilter = string.Empty;
    private string NameFilter = string.Empty;
    private string FirstNameFilter = string.Empty;

    private DialogComponent? ConfirmationDialog;
    private ApplicationUser? dialogUser;
    private string? confirmationMessage;

    IQueryable<ApplicationUser> FilteredUsers
    {
        get
        {
            var result = context.Users.AsQueryable();

            if (!string.IsNullOrEmpty(UserNameFilter))
            {
                // The LINQ needs to be translated to SQL, so no arguments of type StringComparison are allowed for .Contains
                result = result.Where(e => e.UserName != null && e.UserName.Contains(UserNameFilter));
            }

            if (!string.IsNullOrEmpty(EmailFilter))
            {
                // The LINQ needs to be translated to SQL, so no arguments of type StringComparison are allowed for .Contains
                result = result.Where(e => e.Email != null && e.Email.Contains(EmailFilter));
            }

            if (!string.IsNullOrEmpty(NameFilter))
            {
                // The LINQ needs to be translated to SQL, so no arguments of type StringComparison are allowed for .Contains
                result = result.Where(e => e.Name != null && e.Name.Contains(NameFilter));
            }

            if (!string.IsNullOrEmpty(FirstNameFilter))
            {
                // The LINQ needs to be translated to SQL, so no arguments of type StringComparison are allowed for .Contains
                result = result.Where(e => e.FirstName != null && e.FirstName.Contains(FirstNameFilter));
            }

            return result;
        }
    }

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    private void EditUser(string userId)
    {
        // Implement edit logic here
    }

    private void DeleteUser(ApplicationUser user)
    {
        dialogUser = user;
        confirmationMessage = $"Are you sure you want to delete user {user.UserName}?";
        ConfirmationDialog?.Show();
    }

    private async Task DeleteUserConfirmed(bool confirmed)
    {
        var user = ConfirmationDialog?.DialogUser; // Retrieve the user from the dialog
        if (confirmed && user != null)
        {
            // Delete the user
            await UserManager.DeleteAsync(user);

            // Refresh the data by reloading the context
            context = await DbFactory.CreateDbContextAsync();

            // Trigger UI refresh
            StateHasChanged();
        }
    }
}
